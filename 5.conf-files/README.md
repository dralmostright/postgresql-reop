## Configuration Files

### postgresql.conf
postgresql.conf is PostgreSQL's main configuration file and the primary source of configuration parameter settings. postgresql.conf is a plain text file generated by initdb and is normally stored in the data directory and my depend upon the platform where the PostgreSQL is installed. This is man file PostgreSQL uses to find configurations when it starts up.

The best way to find is querying the database itself, and you can also use os commands like ```locate``` and ```find``` too.
```
postgres=# show config_file;
              config_file
----------------------------------------
 /var/lib/pgsql/15/data/postgresql.conf
(1 row)

postgres=#
```
The file has lots of configuration parameters related to memory, wal, authentication and many more, which we can customize according to our need. One parameter can be specified on each line as a name/value setting; blank lines will be ignored. Any part of a line following a hash mark (#) will be treated as a comment. White space within a line is not significant, and the equals sign (=) between name and value is optional, provided there is at least one whitespace character separating them. Parameters which include whitespace must be quoted with single quotes. In the rare case that single quotes occur in parameter values, these must be escaped either using two quotes or with a backslash (\').

Excerpt of the sample file.
```
# Comment
port = 5432
ssl on
shared_buffers = 512MB  # very important to get this right!
default_transaction_isolation = 'read committed'
log_line_prefix = '[\'foo''] ' # this log line prefix will be printed as: "['foo'] "
```

#### Making changes to postgresql.conf
postgresql.conf can be altered using any text editor; use of a provisioning system is generally a sensible way of managing this and related files. The PostgreSQL configuration can also modified with the SQL command ALTER SYSTEM (PostgreSQL 9.4 and later). This does not change postgresql.conf directly; instead changes are written to the special file postgresql.auto.conf, which overrides settings in postgresql.conf. 

#### Activating changes
postgresql.conf is read at server startup. Any changes made while the server is running will not be automatically become effective; a SIGHUP signal must be sent, which can be performed with pg_ctl reload or by executing SELECT pg_reload_conf(). Some configuration parameters require that the server is restarted.

Just for demo we will change the timezone parameter.

```
postgres=# \x
Expanded display is on.
postgres=# select * from pg_settings where name ='TimeZone';
-[ RECORD 1 ]---+----------------------------------------------------------------
name            | TimeZone
setting         | Asia/Kathmandu
unit            |
category        | Client Connection Defaults / Locale and Formatting
short_desc      | Sets the time zone for displaying and interpreting time stamps.
extra_desc      |
context         | user
vartype         | string
source          | configuration file
min_val         |
max_val         |
enumvals        |
boot_val        | GMT
reset_val       | Asia/Kathmandu
sourcefile      | /var/lib/pgsql/15/data/postgresql.conf
sourceline      | 713
pending_restart | f

postgres=# select now();
-[ RECORD 1 ]------------------------
now | 2024-02-05 13:04:41.25457+05:45

postgres=#
```

Now lets change the parameter using alter system:
```
postgres=# alter system set timezone = 'UTC-4';
ALTER SYSTEM
postgres=# select now();
-[ RECORD 1 ]-------------------------
now | 2024-02-05 13:07:55.172824+05:45

postgres=#
```
We can see that the value has been changed but not reflected, however this has been updated in ```postgresql.auto.conf``` file.

```
[root@testdb data]# cat postgresql.auto.conf
# Do not edit this file manually!
# It will be overwritten by the ALTER SYSTEM command.
timezone = 'UTC-4'
[root@testdb data]#
```
As discussed in earlier section we can reload the conf using below:
```
postgres=# SELECT pg_reload_conf();
 pg_reload_conf
----------------
 t
(1 row)

postgres=# select now();
              now
-------------------------------
 2024-02-05 11:27:33.589324+04
(1 row)

postgres=#
```

Now we will reload using pg_ctl too. In case if you are not able to fing pg_ctl, there are high chances your environment variables are not properly configured. Hence check if its actually installed or not using below:
```
[postgres@testdb ~]$ rpm -ql postgresql15-server | grep pg_ctl
/usr/pgsql-15/bin/pg_ctl
/usr/pgsql-15/share/man/man1/pg_ctl.1
[postgres@testdb ~]$
```

As we can see its intalled we will just need to make proper enty in environment variables.
Now lets try with pg_ctl reload, it doesn't restarted the database cluster.
```
[postgres@testdb ~]$ pg_ctl reload
server signaled
[postgres@testdb ~]$
```

### The pg_hba.conf File

Client authentication is controlled by a configuration file, which traditionally is named pg_hba.conf and is stored in the database cluster's data directory. (HBA stands for host-based authentication.) A default pg_hba.conf file is installed when the data directory is initialized by initdb. The configuration file has 5 parameters, namely: TYPE (host type), DATABASE (database name), USER (user name), ADDRESS (IP address and mask), METHOD (encryption method - Authentication methods/options).

In the beginning, you need to know two basic types, local and host. "local" means local domain socket and only local processes can access it. "host" means "TCP" connection. The second field is the "database" name that the client wants to access. The rest fields are user, source ip/address (for local access, there is no ip/address), authentication method, and authentication options. The following is an example record.
```
[postgres@testdb data]$ cat pg_hba.conf | tail -13 | head -3
# "local" is for Unix domain socket connections only
local   all             postgres                                scram-sha-256
host    devdb           ram                   172.20.10.0/24    scram-sha-256
local   all             all                                     md5
[postgres@testdb data]$
```
If we go with the second record, user postgres can connect to devdb database from subnet 172.20.10.0/24 IP range should use scram-sha-256 password to authenticate.

The pg_hba.conf “record order” rule of thumb: narrow range connection with weak authentication first, then open the range of client connection with more robust authentication. As you can see in the first record in the example, all users who connect from the local socket to all databases should use peer authentication. If users are not connecting from the local socket, PostgreSQL tries to evaluate the next record (host all all 127.0.0.1/32 scram-sha-256) till all are exhausted.

The change in HBA requires a reload of PostgreSQL, you don't have to implement a restart at this point. This can be done in SQL with the following query, when connected to your PostgreSQL node:
```
SELECT pg_reload_conf();
```
You can do it from the command line too, using ```pg_ctl reload``` and other OS provided variants.
